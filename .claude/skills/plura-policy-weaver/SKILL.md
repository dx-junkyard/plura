---
name: plura-policy-weaver
description: |
  PLURAの「Policy Weaver（共有知のタペストリー化）」機能に関するドメイン知識と実装ガイドライン。
  ポリシーモデルの設計・実装・評価時に参照するスキル。
  使用タイミング: Policy Weaver関連のデータモデル設計、ポリシー判定ロジック実装、TTL管理、Override記録の実装時。
---

# 📂 PLURA Policy Weaver Skill

## 概要
PLURAの「Policy Weaver（共有知のタペストリー化）」機能に関するドメイン知識と実装ガイドライン。

## 🧠 Policy Weaver コア原則 (Core Principles)
ClaudeはPolicy Weaver関連の実装において、以下の原則を絶対に順守すること。

1. **二段階制度化 (Heuristic First):**
   - いきなりシステムを強制ブロックするコード（Strict Policy）は生成しない。
   - まずはLLMが読み込むための `Prompt as Code` (強制力: `Suggest` または `Warn`) として実装する。
2. **ワクチン型ポリシー (TTL Driven):**
   - 永遠に続くルールは組織の官僚的硬直化を招く。すべてのポリシーモデルには必ず `ttl_expires_at` (再評価期限) を設ける。
3. **逸脱の歓迎 (Override as Fuel):**
   - ユーザーがルールを無視（Override）することはエラーではなく「ルールの境界条件を更新するための主燃料」である。
   - Overrideを記録し、それを元にポリシーを再評価するフィードバックループをAPIやデータモデルに組み込むこと。

## 📦 データモデルの制約
- `Policy` 関連のモデルでは、ルールを単一のテキストではなく、`dilemma_context`, `principle`, `boundary_conditions` (applies_when / except_when) のJSONスキーマ（GraphComplianceアプローチ）として構造化して保存すること。

## 🛠️ 禁止事項
- ユーザーのアクションを無条件で `BLOCK` するような静的バリデーションを初期実装から組み込むこと（常に `Suggest` か `Warn` から始める）。

---

## ⚖️ LLM-as-a-Judge 評価軸

Policy Weaverの出力・判定品質を評価する際は、以下の3軸を基準として用いること。
これらはClaudeが実装・評価を行う際に守るべきルールであり、Pythonコードとして書くのではなく、プロンプトや評価指示として機能する。

### 評価軸の定義

#### 1. `heuristic_compliance` — 二段階制度化の遵守

**定義:** 生成・提案されたポリシーが「Suggest → Warn → Block」の段階的強制力の原則に従っているかを評価する。

**採点基準（1-10）:**
- **10点:** ポリシーが `Suggest` または `Warn` として設計されており、即座に `Block` する記述が一切ない。段階的エスカレーションのパスが明示されている。
- **7-9点:** 基本的に段階的強制力を守っているが、一部の境界条件で `Block` に近い表現が見られる。
- **4-6点:** `Block` を前提とした記述が混在しており、修正が必要。
- **1-3点:** 初期実装から `BLOCK` やハードな制約を組み込んでいる。原則違反。

**チェックポイント:**
- ポリシーの `enforcement_level` フィールドが `suggest` か `warn` になっているか
- `Block` 相当の処理は、最低2段階のエスカレーション後にのみ発動するか
- `Prompt as Code` として実装されているか（LLMが読み込む形式）

---

#### 2. `boundary_clarity` — 境界条件の明確さ

**定義:** ポリシーの `boundary_conditions`（applies_when / except_when）が具体的かつ明確に定義されており、曖昧さや解釈の余地が最小化されているかを評価する。

**採点基準（1-10）:**
- **10点:** `applies_when` と `except_when` がそれぞれ具体的な条件で記述されており、境界ケースが網羅されている。
- **7-9点:** 主要な条件は明確だが、一部の境界ケースが未定義または曖昧。
- **4-6点:** 条件が抽象的すぎて、実装者やLLMによって解釈が分かれる可能性がある。
- **1-3点:** `applies_when` / `except_when` が未定義、またはすべてを包括する記述のみ（例:「全ての場合に適用」）。

**チェックポイント:**
- `applies_when` に少なくとも1つ以上の具体的条件が記載されているか
- `except_when`（例外条件）が定義されているか
- `dilemma_context` が記述されており、なぜこのポリシーが存在するかの背景が説明されているか
- Override発生時にどの境界条件が破られたかを追跡できる構造になっているか

---

#### 3. `ttl_appropriateness` — TTLの妥当性

**定義:** ポリシーに設定された `ttl_expires_at`（再評価期限）が、そのポリシーの性質・リスク・変化速度に対して適切な期間に設定されているかを評価する。

**採点基準（1-10）:**
- **10点:** TTLがポリシーの内容・リスクレベルに応じて適切に設定されており、再評価のトリガー条件も定義されている。
- **7-9点:** TTLは設定されているが、期間設定の根拠がやや不明確。
- **4-6点:** TTLが設定されているが、期間が極端に長い（例: 10年以上）または短すぎる（例: 1日）。
- **1-3点:** `ttl_expires_at` が未設定（null）または無期限。

**TTL設定の目安:**
| ポリシーの種類 | 推奨TTL |
|---|---|
| 実験的・試験的ルール | 2〜4週間 |
| チーム内運用ルール | 3〜6ヶ月 |
| 組織横断的なポリシー | 6ヶ月〜1年 |
| 外部規制・法令準拠 | 1年（ただし法改正時に即再評価） |

**チェックポイント:**
- `ttl_expires_at` フィールドが必ず存在し、null でないか
- TTLの期間がポリシーの変化速度・リスクと釣り合っているか
- TTL到達時の再評価フローが設計されているか（誰が・いつ・何を判断するか）
- Override累積数がしきい値を超えた場合に早期再評価をトリガーする仕組みがあるか
