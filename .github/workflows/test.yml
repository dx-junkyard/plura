name: CI Tests

on:
  push:
    branches:
      - main
      - development
      - "claude/**"
  pull_request:
    branches:
      - main
      - development

jobs:
  # ============================================================
  # Backend: Python ユニットテスト（LLM/DB モック済み）
  # ============================================================
  backend-test:
    name: Backend Tests (Python)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          # 1. 念のためpipを最新化
          python -m pip install --upgrade pip
          
          # 2. pkg_resourcesが含まれているバージョンのsetuptoolsとwheelをシステムにインストール
          pip install "setuptools<70.0.0" wheel
          
          # 3. whisperのみ、隔離環境を作らず（--no-build-isolation）現在の環境のsetuptoolsを使ってインストール
          pip install --no-build-isolation openai-whisper==20240930
          
          # 4. 残りのパッケージ群を通常通りインストール（whisperはインストール済みとしてスキップされます）
          pip install -r requirements.txt

          # 5. テスト実行に必要な追加パッケージをインストール
          pip install aiosqlite

      - name: Run unit tests
        run: |
          pytest tests/ \
            --asyncio-mode=auto \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            -v
        env:
          PYTHONPATH: .
          # テスト用ダミー環境変数（実際のAPIキーは不要）
          DATABASE_URL: "sqlite+aiosqlite:///./test.db"
          SECRET_KEY: "test-secret-key-for-ci-only"
          OPENAI_API_KEY: "sk-test-dummy-key"
          GOOGLE_CLOUD_PROJECT: "test-project"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage.xml

  # ============================================================
  # Frontend: Vitest + MSW モックテスト
  # ============================================================
  frontend-test:
    name: Frontend Tests (Node.js + MSW)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Run tests
        run: npm test

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/

  # ============================================================
  # Lint チェック
  # ============================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: ESLint
        run: cd frontend && npm run lint
